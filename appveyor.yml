version: 1.0.{build}
image: Visual Studio 2017
before_build:
    - ps: |
        nuget restore BuildCrossCheck.sln -Verbosity Quiet
        cd ./BCC.web
        npm install
        cd ..
build_script:
- ps: >-
    msbuild BuildCrossCheck.sln --% /p:Configuration=Release /bl:output.binlog /verbosity:minimal
after_build:
    - cmd: dotnet publish BCC.Web --configuration Release --output %appveyor_build_folder%\dist
    - cmd: dotnet pack -c Release .\BCC.MSBuildLog\BCC.MSBuildLog.csproj -o ..\
    - cmd: dotnet pack -c Release .\BCC.Submission\BCC.Submission.csproj -o ..\
test_script:
    - cmd: '%xunit20%\xunit.console.x86 "%appveyor_build_folder%\BCC.Core.Tests\bin\Release\net471\BCC.Core.Tests.dll" -appveyor'
    - cmd: '%xunit20%\xunit.console.x86 "%appveyor_build_folder%\BCC.MSBuildLog.Tests\bin\Release\net471\BCC.MSBuildLog.Tests.dll" -appveyor'
    - cmd: '%xunit20%\xunit.console.x86 "%appveyor_build_folder%\BCC.Submission.Tests\bin\Release\net471\BCC.Submission.Tests.dll" -appveyor'
    - cmd: dotnet test -c Release BCC.Core.Tests\BCC.Core.Tests.csproj --logger:Appveyor
    - cmd: dotnet test -c Release BCC.MSBuildLog.Tests\BCC.MSBuildLog.Tests.csproj --logger:Appveyor
    - cmd: dotnet test -c Release BCC.Submission.Tests\BCC.Submission.Tests.csproj --logger:Appveyor
    - cmd: dotnet test -c Release BCC.Web.Tests\BCC.Web.Tests.csproj --logger:Appveyor
    - cmd: dotnet test -c Release Cake.BCC.Tests\Cake.BCC.Tests.csproj --logger:Appveyor
after_test:
- ps: |  
    dotnet tool install --global coverlet.console
    coverlet .\BCC.Core.Tests\bin\Release\netcoreapp2.1\BCC.Core.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.Core.Tests\BCC.Core.Tests.csproj --no-build" --format opencover --output ".\BCC.Core.Tests-netcoreapp2.1.coverage.xml"
    coverlet .\BCC.Web.Tests\bin\Release\netcoreapp2.1\BCC.Web.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.Web.Tests\BCC.Web.Tests.csproj --no-build" --format opencover --output ".\BCC.Web.Tests-netcoreapp2.1.coverage.xml"
    coverlet .\BCC.MSBuildLog.Tests\bin\Release\netcoreapp2.1\BCC.MSBuildLog.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.MSBuildLog.Tests\BCC.MSBuildLog.Tests.csproj --no-build" --format opencover --output ".\BCC.MSBuildLog.Tests-netcoreapp2.1.coverage.xml"
    coverlet .\BCC.Submission.Tests\bin\Release\netcoreapp2.1\BCC.Submission.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.Submission.Tests\BCC.Submission.Tests.csproj --no-build" --format opencover --output ".\BCC.Submission.Tests-netcoreapp2.1.coverage.xml"
    coverlet .\Cake.BCC.Tests\bin\Release\netcoreapp2.1\Cake.BCC.Tests.dll --target "dotnet" --targetargs "test -c Release .\Cake.BCC.Tests\Cake.BCC.Tests.csproj --no-build" --format opencover --output ".\Cake.BCC.Tests-netcoreapp2.1.coverage.xml"
    coverlet .\BCC.Core.Tests\bin\Release\net471\BCC.Core.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.Core.Tests\BCC.Core.Tests.csproj --no-build" --format opencover --output ".\BCC.Core.Tests-net471.coverage.xml"
    coverlet .\BCC.MSBuildLog.Tests\bin\Release\net471\BCC.MSBuildLog.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.MSBuildLog.Tests\BCC.MSBuildLog.Tests.csproj --no-build" --format opencover --output ".\BCC.MSBuildLog.Tests-net471.coverage.xml"
    coverlet .\BCC.Submission.Tests\bin\Release\net471\BCC.Submission.Tests.dll --target "dotnet" --targetargs "test -c Release .\BCC.Submission.Tests\BCC.Submission.Tests.csproj --no-build" --format opencover --output ".\BCC.Submission.Tests-net471.coverage.xml"
    choco install --no-progress codecov
    codecov -f ".\BCC.Core.Tests-netcoreapp2.1.coverage.xml"
    codecov -f ".\BCC.Web.Tests-netcoreapp2.1.coverage.xml"
    codecov -f ".\BCC.MSBuildLog.Tests-netcoreapp2.1.coverage.xml"
    codecov -f ".\BCC.Submission.Tests-netcoreapp2.1.coverage.xml"
    codecov -f ".\Cake.BCC.Tests-netcoreapp2.1.coverage.xml"
    codecov -f ".\BCC.Core.Tests-net471.coverage.xml"
    codecov -f ".\BCC.MSBuildLog.Tests-net471.coverage.xml"
    codecov -f ".\BCC.Submission.Tests-net471.coverage.xml"
artifacts:
    - path: '*.coverage.xml'
      type: File
    - path: dist
      name: dist.web
      type: WebDeployPackage
    - path: '*.nupkg'
    - path: 'Cake.BCC\bin\Release\*.nupkg'